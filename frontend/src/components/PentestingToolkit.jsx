/**
 * PentestingToolkit Component
 * 
 * Unified React component for executing various pentesting tools (Nmap, Nikto, Dirb).
 * Provides a tool selector dropdown and dynamically renders input forms based on
 * the selected tool.
 * 
 * Features:
 * - Tool selection dropdown (Nmap, Nikto, Dirb)
 * - Dynamic form rendering based on selected tool
 * - Target input with validation hints
 * - Options input for tool-specific flags
 * - Loading spinner during scan execution
 * - Scrollable output display for scan results
 * - Error handling and display
 */

import React, { useState } from 'react';
import { Card, Form, Button, Alert, Spinner, Container } from 'react-bootstrap';
import { api } from '../services/api';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';

export default function PentestingToolkit() {
  const navigate = useNavigate();
  const { logout } = useAuth();
  
  // Component state management
  const [selectedTool, setSelectedTool] = useState('nmap');
  const [target, setTarget] = useState('');
  const [options, setOptions] = useState('');
  const [scanResult, setScanResult] = useState(null);
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  /**
   * Tool configuration - defines tool-specific properties
   */
  const toolConfig = {
    nmap: {
      name: 'Nmap',
      description: 'Network discovery and port scanning',
      targetPlaceholder: 'e.g., example.com or 192.0.2.1',
      targetHint: 'Enter a valid IP address or domain name (private IPs are not allowed)',
      optionsPlaceholder: 'e.g., -sV -p 80,443',
      optionsHint: 'Nmap options/flags separated by spaces',
      icon: 'üîç',
    },
    nikto: {
      name: 'Nikto',
      description: 'Web server vulnerability scanner',
      targetPlaceholder: 'e.g., https://example.com',
      targetHint: 'Enter a valid URL starting with http:// or https://',
      optionsPlaceholder: 'e.g., -Display V',
      optionsHint: 'Nikto options/flags separated by spaces',
      icon: 'üï∑Ô∏è',
    },
    dirb: {
      name: 'Dirb',
      description: 'Web directory brute-forcer',
      targetPlaceholder: 'e.g., https://example.com',
      targetHint: 'Enter a valid URL starting with http:// or https://',
      optionsPlaceholder: 'e.g., -w -S',
      optionsHint: 'Dirb options/flags separated by spaces',
      icon: 'üìÅ',
    },
  };

  /**
   * Handle tool selection change
   */
  const handleToolChange = (e) => {
    const newTool = e.target.value;
    setSelectedTool(newTool);
    // Reset form when switching tools
    setTarget('');
    setOptions('');
    setScanResult(null);
    setError('');
  };

  /**
   * Handle form submission
   * Routes to appropriate API endpoint based on selected tool
   */
  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // Reset previous results and errors
    setError('');
    setScanResult(null);
    setLoading(true);

    try {
      // Parse options string into array
      const optionsArray = options
        .split(/\s+/)
        .filter(opt => opt.trim().length > 0);

      // Prepare request payload
      const payload = {
        target: target.trim(),
        options: optionsArray,
      };

      // Route to appropriate API endpoint based on selected tool
      let result;
      switch (selectedTool) {
        case 'nmap':
          result = await api.runNmapScan(payload);
          break;
        case 'nikto':
          result = await api.runNiktoScan(payload);
          break;
        case 'dirb':
          result = await api.runDirbScan(payload);
          break;
        default:
          throw new Error('Invalid tool selected');
      }
      
      // Set scan result
      setScanResult(result);
      
    } catch (err) {
      // Handle errors from API
      setError(err.message || 'Failed to execute scan. Please try again.');
      console.error('Scan error:', err);
    } finally {
      // Always disable loading state
      setLoading(false);
    }
  };

  /**
   * Handle form reset
   */
  const handleReset = () => {
    setTarget('');
    setOptions('');
    setScanResult(null);
    setError('');
    setLoading(false);
  };

  /**
   * Handle logout
   */
  const handleLogout = async () => {
    try {
      await logout();
      navigate('/login');
    } catch (error) {
      setError('Failed to log out');
    }
  };

  const currentTool = toolConfig[selectedTool];

  return (
    <div className="page-shell">
      <Container className="page-container">
        <header className="glass-nav d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
          <div>
            <p className="eyebrow mb-1">Security toolkit</p>
            <h2 className="h4 mb-0 brand-gradient">Pentesting Control Deck</h2>
          </div>
          <div className="d-flex flex-wrap gap-2">
            <Button className="btn-modern-secondary" onClick={() => navigate('/dashboard')}>
              Dashboard
            </Button>
            <Button className="btn-modern-primary" onClick={handleLogout}>
              Logout
            </Button>
          </div>
        </header>

        <Card className="card-glass border-0 shadow-lg">
          <Card.Header className="bg-transparent border-0 pb-0">
            <h4 className="text-white fw-bold mb-0">
              üîí Pentesting Toolkit
            </h4>
            <p className="text-muted small mb-0">
              Integrated security scanning tools for network and web application testing
            </p>
          </Card.Header>
          
          <Card.Body>
            {/* Error Alert */}
            {error && (
              <Alert 
                variant="danger" 
                className="mb-4" 
                onClose={() => setError('')} 
                dismissible
              >
                <strong>Error:</strong> {error}
              </Alert>
            )}

            {/* Tool Selection */}
            <Form.Group className="mb-4">
              <Form.Label className="text-white fw-semibold">
                Select Tool <span className="text-danger">*</span>
              </Form.Label>
              <Form.Select
                value={selectedTool}
                onChange={handleToolChange}
                disabled={loading}
                className="select-dark"
              >
                <option value="nmap">üîç Nmap - Network Scanner</option>
                <option value="nikto">üï∑Ô∏è Nikto - Web Server Scanner</option>
                <option value="dirb">üìÅ Dirb - Directory Brute-Forcer</option>
              </Form.Select>
              <Form.Text className="text-muted">
                {currentTool.description}
              </Form.Text>
            </Form.Group>

            {/* Scan Form */}
            <Form onSubmit={handleSubmit}>
              <Form.Group className="mb-3">
                <Form.Label className="text-white fw-semibold">
                  Target <span className="text-danger">*</span>
                </Form.Label>
                <Form.Control
                  type="text"
                  placeholder={currentTool.targetPlaceholder}
                  value={target}
                  onChange={(e) => setTarget(e.target.value)}
                  disabled={loading}
                  required
                  className="input-dark"
                />
                <Form.Text className="text-muted">
                  {currentTool.targetHint}
                </Form.Text>
              </Form.Group>

              <Form.Group className="mb-4">
                <Form.Label className="text-white fw-semibold">
                  Options (Optional)
                </Form.Label>
                <Form.Control
                  type="text"
                  placeholder={currentTool.optionsPlaceholder}
                  value={options}
                  onChange={(e) => setOptions(e.target.value)}
                  disabled={loading}
                  className="input-dark"
                />
                <Form.Text className="text-muted">
                  {currentTool.optionsHint}
                </Form.Text>
              </Form.Group>

              {/* Action Buttons */}
              <div className="d-flex gap-2">
                <Button
                  type="submit"
                  className="btn-modern-primary flex-grow-1"
                  disabled={loading || !target.trim()}
                >
                  {loading ? (
                    <>
                      <Spinner
                        as="span"
                        animation="border"
                        size="sm"
                        role="status"
                        aria-hidden="true"
                        className="me-2"
                      />
                      Scanning...
                    </>
                  ) : (
                    `üöÄ Run ${currentTool.name} Scan`
                  )}
                </Button>
                
                <Button
                  type="button"
                  className="btn-modern-secondary"
                  onClick={handleReset}
                  disabled={loading}
                >
                  Reset
                </Button>
              </div>
            </Form>

            {/* Scan Results Display */}
            {scanResult && (
              <div className="mt-4">
                <hr className="border-secondary" />
                
                <div className="d-flex justify-content-between align-items-center mb-3">
                  <h5 className="text-white mb-0">Scan Results</h5>
                  <span
                    className={`badge ${
                      scanResult.success ? 'bg-success' : 'bg-warning'
                    }`}
                  >
                    {scanResult.success ? '‚úì Success' : '‚ö† Completed with warnings'}
                  </span>
                </div>

                {/* Scan Output */}
                {scanResult.output && (
                  <div className="mb-3">
                    <Form.Label className="text-white small fw-semibold">
                      Output:
                    </Form.Label>
                    <Form.Control
                      as="textarea"
                      rows={12}
                      value={scanResult.output}
                      readOnly
                      className="textarea-output input-dark"
                      style={{
                        fontSize: '0.875rem',
                        resize: 'vertical',
                      }}
                    />
                  </div>
                )}

                {/* Error Output (if any) */}
                {scanResult.error && (
                  <div>
                    <Form.Label className="text-warning small fw-semibold">
                      Errors/Warnings:
                    </Form.Label>
                    <Form.Control
                      as="textarea"
                      rows={4}
                      value={scanResult.error}
                      readOnly
                      className="textarea-output text-warning border-warning"
                      style={{
                        fontSize: '0.875rem',
                      }}
                    />
                  </div>
                )}

                {/* Scan Metadata */}
                <div className="mt-3 p-3 surface-soft rounded border border-secondary">
                  <small className="text-muted">
                    <strong>Tool:</strong> {scanResult.tool} |{' '}
                    <strong>Target:</strong> {scanResult.target}
                  </small>
                </div>
              </div>
            )}
          </Card.Body>
        </Card>
      </Container>
    </div>
  );
}

